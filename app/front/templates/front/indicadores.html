{% extends "base.html" %}
{% block content %}
{% load static %}

<script>
    computeIndicadoresUrl= "{% url 'front:compute_indicadores' %}";
  </script>
<link href="{% static 'css/select2.min.css' %}" rel="stylesheet">
<script src="{% static 'vendor/select2/select2.min.js' %}"></script>
<!-- context to js -->
{{group_by_choices| json_script:"group_by_choices_data"}}
{{filter_by_choices| json_script:"filter_by_choices_data"}}
{{filter_values_options| json_script:"filter_values_data"}}
{{objects_qs| json_script:"objects_qs_data"}}
<div class="pb-5 pt-2 bg-light w-100">
  <div class="container-lg">
    <h1 class="fs-3 mb-2 mt-2">Indicadores de Agregación</h1>
    <div class="container-lg">
      <p class="fs-6 p-2 mb-3 rounded">
        En esta sección puedes explorar los indicadores de agregación. Selecciona el recurso, el criterio de agrupación y los filtros para visualizar los datos en gráficos interactivos.
      </p>
    </div>
    <div class="row">
      <div class="row mb-3">
        <form id="indicadores-form" class="d-flex justify-content-center gap-2 align-items-end" method="get"
        action ="{% url 'front:compute_indicadores' %}"
        >
          <div class="card">
            <label class="form-label card-header">Recurso a Filtrar</label>
            <div class="card-body p-3">
              <select name="model" id="model" class="form-select form-select-sm">
                {% for choice in model_choices %}
                  {% if choice.value == 'academico' %}
                      <option value="{{ choice.value }}" selected>{{ choice.label }}</option>
                  {% else %}
                      <option value="{{ choice.value }}">{{ choice.label }}</option>
                  {% endif %}
              {% endfor %}
              </select>
            </div>
          </div>
          <div class="card">
            <label class="form-label card-header">Agrupar por</label>
            <div class="card-body p-3">
              <select name="group_by" id="group_by" class="form-select form-select-sm">
              </select>
            </div>
          </div>
          <div class="card d-none">
            <!-- se esconde esto por ahora, solo confunde -->
            <label class="form-label card-header">Filtrar por</label>
            <div class="card-body p-3 d-flex gap-1" style="width: 328px;">
              <div>
                <select name="filter_by" id="filter_by" class="form-select form-select-sm">
                  <option value="" selected></option>
                </select>
              </div>
              <div>
                <select name="filter_values" id="filter_values" class="form-select form-select-sm" multiple="multiple"  style="min-width:165px;">
                </select>
              </div>
            </div>
          </div>
          <div class="d-flex ms-2 p-1">
            <button type="button" id="btn_compute" class="btn btn-primary btn-sm p-2"
            onclick="fetchIndicadores()"
            >Calcular</button>
          </div>
        </form>
      </div>
        <div class="container" id="indicadores-results-container">
            <div class="text-center mb-4" style="border-bottom: 1px solid #adb5bd">
              <button
                id="count-chart-section"
                type="button"
                class="btn btn-light query-type-selector me-1 selected p-2"
                onclick="toggleSectionVisibility('countChart')"
                disabled
              >
                Gráfico de Barras
              </button>
              <button
                id="pie-chart-section"
                type="button"
                class="btn btn-light query-type-selector btn.disabled p-2"
                onclick="toggleSectionVisibility('pieChart')"
                disabled
              >
                Gráfico de Pastel
              </button>
            </div>
            <div id="chart-container" class="d-none">
              <div id="count-chart-stage-content" class="" >
                <canvas id="indicadoresCountChart" class="" style="max-height: 450px;" ></canvas>
              </div>
              <div id="pie-chart-stage-content" class="d-none" >
                <canvas id="indicadoresPieChart" class="" style="max-height: 450px;"></canvas>
              </div>
              <div class="d-flex justify-content-end mt-3">  
                <a
                  id="btn_export_excel"
                  style="cursor:pointer"
                  onclick="exportToExcel()"
  
                >
                  Descargar Detalle
                  <i class="bi bi-download ms-1"></i>
              </a>
  
              </div>
            </div>
      </div>
  </div>
</div>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js" type="module" > </script> -->
<script src="{% static 'vendor/chart.js/chart.umd.min.js' %}"></script>
<script src="{% static 'vendor/xlsx/xlsx.full.min.js' %}"></script>
<script src="{% static 'front/indicadores.js' %}"></script>
{% endblock content %}

